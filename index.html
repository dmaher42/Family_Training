<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Family Training Hub</title>
    <link rel="stylesheet" href="./themes.css" />
    <style>
      :root {
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: var(--font-sans);
        background: var(--bg);
        color: var(--fg);
        -webkit-font-smoothing: antialiased;
        line-height: 1.5;
      }

      main {
        max-width: 1000px;
        margin: 0 auto;
        padding: 32px 20px 64px;
      }

      /* Top Bar */
      .top-bar {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 24px;
        margin-bottom: 40px;
      }

      .title {
        margin: 0;
        font-size: 24px;
        font-weight: 800;
        letter-spacing: -0.025em;
        color: var(--fg);
      }

      .muted {
        color: var(--muted);
        font-size: 14px;
        font-weight: 500;
      }

      .controls {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .control-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--muted);
      }

      select {
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        background: var(--card);
        color: var(--fg);
        font-size: 14px;
        font-family: inherit;
        font-weight: 500;
        box-shadow: var(--shadow-sm);
        cursor: pointer;
        min-width: 160px;
      }

      select:focus {
        outline: 2px solid var(--accent);
        outline-offset: 1px;
      }

      /* Buttons */
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 9999px; /* Pill shape */
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-width: 100px;
      }

      .btn-primary {
        background: var(--fg);
        color: var(--bg);
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-1px);
        opacity: 0.9;
        box-shadow: var(--shadow-md);
      }

      .btn-ghost {
        background: transparent;
        color: var(--muted);
        border: 1px solid transparent;
      }

      .btn-ghost:hover:not(:disabled) {
        background: var(--bg);
        color: var(--fg);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: default;
      }

      .toggle {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        user-select: none;
      }

      /* Plan Header */
      .plan-header {
        margin-bottom: 40px;
      }

      .plan-title {
        margin: 0;
        font-size: 36px;
        font-weight: 800;
        letter-spacing: -0.03em;
        line-height: 1.1;
      }

      .plan-subtitle {
        margin: 12px 0 0;
        color: var(--muted);
        font-size: 18px;
        font-weight: 500;
        max-width: 600px;
      }

      #planOverview {
        margin-top: 16px;
        line-height: 1.6;
        max-width: 700px;
      }

      /* Week Container */
      .week-container {
        margin-bottom: 48px;
      }

      .week-title {
        font-size: 20px;
        font-weight: 700;
        margin: 0 0 24px;
        letter-spacing: -0.02em;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .week-title::after {
        content: "";
        flex: 1;
        height: 1px;
        background: var(--border);
        opacity: 0.5;
      }

      /* Day Card */
      .day-card {
        background: var(--card);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid rgba(0,0,0,0.03); /* Soft border */
        margin-bottom: 24px;
        display: grid;
        grid-template-columns: 260px 1fr;
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .day-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }

      .day-card.is-complete {
        opacity: 0.85;
        border-color: var(--border);
      }

      .day-card.is-skipped {
        opacity: 0.6;
        filter: grayscale(0.8);
      }

      /* Left Rail (Meta) */
      .day-meta {
        background: linear-gradient(to right, var(--bg), transparent); /* Subtle visual separation */
        padding: 24px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        border-right: 1px solid transparent; /* Cleaner without border, relying on bg */
      }

      [data-theme="dark"] .day-meta {
          background: rgba(255, 255, 255, 0.03);
      }

      .day-header {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .day-name {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: var(--fg);
        line-height: 1.3;
      }

      .day-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 99px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .badge-tag {
        background: var(--bg);
        color: var(--muted);
        border: 1px solid var(--border);
      }

      .badge-status-done {
        background: #dcfce7;
        color: #166534;
      }

      [data-theme="dark"] .badge-status-done {
        background: #14532d;
        color: #dcfce7;
      }

      .badge-status-skipped {
        background: var(--bg);
        color: var(--muted);
        text-decoration: line-through;
      }

      .day-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 24px;
      }

      /* Content Section */
      .day-content {
        padding: 24px 32px;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .day-focus {
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 16px;
        background: var(--bg);
        border-radius: var(--radius-md);
        margin-bottom: 8px;
      }

      .focus-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-weight: 700;
        color: var(--muted);
      }

      .day-focus p {
        margin: 0;
        font-size: 15px;
        font-style: italic;
        color: var(--fg);
      }

      .exercise-block {
        /* Optional: distinct styling for blocks */
      }

      .block-title {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--muted);
        margin: 0 0 12px;
        font-weight: 700;
        border-bottom: 1px solid var(--border);
        padding-bottom: 4px;
        display: inline-block;
      }

      ul {
        margin: 0;
        padding-left: 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      li {
        color: var(--fg);
        font-size: 15px;
        line-height: 1.6;
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .day-card {
          grid-template-columns: 1fr;
        }

        .day-meta {
          flex-direction: row;
          align-items: flex-start;
          background: var(--bg);
          border-bottom: 1px solid var(--border);
          padding: 16px;
        }

        .day-actions {
          margin-top: 0;
          align-items: flex-end;
        }

        .day-content {
          padding: 20px;
        }

        .btn {
            min-width: auto;
        }
      }

      /* Gamification Styles */
      .gamification-dashboard {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.04);
        display: none; /* Hidden by default */
        animation: fadeIn 0.3s ease-out;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .scorecard-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
        flex-wrap: wrap;
        gap: 12px;
      }

      .scorecard-stats {
        display: flex;
        gap: 24px;
      }

      .stat-item {
        display: flex;
        flex-direction: column;
      }

      .stat-value {
        font-size: 24px;
        font-weight: 800;
        color: var(--accent);
      }

      .stat-label {
        font-size: 12px;
        color: var(--muted);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .coach-message {
        font-style: italic;
        color: var(--fg);
        margin-top: 8px;
        font-size: 15px;
        border-left: 3px solid var(--accent);
        padding-left: 12px;
        max-width: 600px;
      }

      .badges-container {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        background: var(--bg);
        border: 1px solid var(--border);
        opacity: 0.5; /* Locked state */
        transition: all 0.3s ease;
      }

      .badge.unlocked {
        opacity: 1;
        border-color: var(--accent);
        background: linear-gradient(to right, var(--bg), var(--card));
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }

      .badge-icon {
        font-size: 16px;
      }

      .progress-section {
        margin-top: 20px;
      }

      .progress-label {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 6px;
      }

      .progress-track {
        height: 8px;
        background: var(--bg);
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: var(--accent);
        width: 0%;
        transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .competition-line {
        margin-top: 12px;
        font-size: 13px;
        color: var(--muted);
        text-align: center;
        width: 100%;
      }

      .gamification-toggle-label {
        margin-top: 12px;
        font-size: 13px;
        color: var(--muted);
      }

      /* Exercise Modal */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease, visibility 0.2s ease;
        padding: 20px;
      }

      .modal-backdrop[aria-hidden="false"] {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: var(--card);
        width: 100%;
        max-width: 500px;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        display: flex;
        flex-direction: column;
        max-height: 90vh;
        transform: scale(0.95);
        transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        border: 1px solid var(--border);
      }

      .modal-backdrop[aria-hidden="false"] .modal {
        transform: scale(1);
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
      }

      .modal-header h2 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: var(--fg);
      }

      .btn-icon {
        background: transparent;
        border: none;
        color: var(--muted);
        font-size: 20px;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
      }

      .btn-icon:hover {
        background: var(--bg);
        color: var(--fg);
      }

      .modal-body {
        padding: 20px;
        overflow-y: auto;
      }

      .modal-image {
        width: 100%;
        border-radius: var(--radius-md);
        margin-bottom: 20px;
        border: 1px solid var(--border);
        display: block;
      }

      .modal-cues {
        margin: 0 0 20px 0;
        padding-left: 20px;
      }

      .modal-cues li {
        margin-bottom: 8px;
        color: var(--fg);
        font-size: 15px;
        line-height: 1.5;
      }

      .modal-note {
        background: var(--bg);
        padding: 12px 16px;
        border-radius: var(--radius-md);
        font-style: italic;
        color: var(--muted);
        border-left: 3px solid var(--accent);
        margin: 0;
        font-size: 14px;
      }

      /* List Item with View Action */
      .list-item-actionable {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        padding: 6px 0;
        width: 100%;
      }

      .list-item-actionable:hover .view-chip {
        background: var(--fg);
        color: var(--bg);
        border-color: var(--fg);
      }

      .list-item-text {
        flex: 1;
        padding-right: 12px;
      }

      .view-chip {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: var(--bg);
        border: 1px solid var(--border);
        color: var(--muted);
        padding: 4px 10px;
        border-radius: 99px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <!-- Modal Scaffold -->
    <div class="modal-backdrop" id="exerciseModalBackdrop" role="dialog" aria-modal="true" aria-hidden="true" hidden>
      <div class="modal" role="document">
        <div class="modal-header">
          <h2 id="exerciseModalTitle"></h2>
          <button id="exerciseModalClose" aria-label="Close" class="btn-icon">âœ•</button>
        </div>
        <div class="modal-body" id="exerciseModalBody"></div>
      </div>
    </div>

    <main>
      <div class="top-bar">
        <div>
          <p class="muted">Family Training Hub</p>
          <h1 class="title">Shared Plan Renderer</h1>
        </div>
        <div class="controls">
          <label class="toggle" for="themeToggle">
            <input type="checkbox" id="themeToggle" />
            <span class="muted">Dark mode</span>
          </label>
          <div class="control-group">
            <label for="planPicker">Choose plan</label>
            <select id="planPicker"></select>
          </div>
          <div class="control-group" id="weekPickerGroup">
            <label for="weekPicker">Choose week</label>
            <select id="weekPicker"></select>
          </div>
        </div>
      </div>

      <!-- Gamification Dashboard -->
      <section id="gamificationDashboard" class="gamification-dashboard">
        <div class="scorecard-header">
          <div class="scorecard-stats">
            <div class="stat-item">
              <span id="weeklyPoints" class="stat-value">0</span>
              <span class="stat-label">This Week</span>
            </div>
            <div class="stat-item">
              <span id="sessionsCompleted" class="stat-value">0/0</span>
              <span class="stat-label">Sessions</span>
            </div>
          </div>
          <div id="coachMessage" class="coach-message"></div>
        </div>

        <div class="progress-section">
          <div class="progress-label">
            <span>Training Blocks Completed</span>
            <span id="totalPointsLabel">0 / 120 pts</span>
          </div>
          <div class="progress-track">
            <div id="totalProgressBar" class="progress-fill"></div>
          </div>
        </div>

        <div id="badgesContainer" class="badges-container"></div>

        <div class="competition-line">
           You vs last week â€” can you match your focus?
        </div>

         <label class="toggle gamification-toggle-label">
            <input type="checkbox" id="gamificationToggle" checked />
            <span class="muted">Show achievements</span>
        </label>
      </section>

      <section class="plan-header">
        <h2 id="planTitle" class="plan-title"></h2>
        <p id="planSubtitle" class="plan-subtitle"></p>
        <p id="planOverview" class="muted"></p>
      </section>

      <section id="weeks" class="weeks"></section>
    </main>

    <script type="module">
      import { PLANS } from "./plans/index.js";
      import { normalizePlan } from "./plans/adapter.js";
      import { resolvePlanForWeek } from "./plans/resolve.js";
      import { loadProgress, saveProgress } from "./progress.js";
      import { initTheme } from "./theme.js";

      const PLAN_KEY = "selected_plan_v1";
      const WEEK_KEY_PREFIX = "selected_week_v1";
      const GAMIFY_TOGGLE_KEY = "isla_gamify_enabled_v1";
      const BADGES_KEY = "badges_v1:isla";

      const planPicker = document.getElementById("planPicker");
      const planTitle = document.getElementById("planTitle");
      const planSubtitle = document.getElementById("planSubtitle");
      const planOverview = document.getElementById("planOverview");
      const weekPicker = document.getElementById("weekPicker");
      const weekPickerGroup = document.getElementById("weekPickerGroup");
      const weeksContainer = document.getElementById("weeks");

      // Gamification Elements
      const gamificationDashboard = document.getElementById("gamificationDashboard");
      const weeklyPointsEl = document.getElementById("weeklyPoints");
      const sessionsCompletedEl = document.getElementById("sessionsCompleted");
      const coachMessageEl = document.getElementById("coachMessage");
      const totalProgressBar = document.getElementById("totalProgressBar");
      const totalPointsLabel = document.getElementById("totalPointsLabel");
      const badgesContainer = document.getElementById("badgesContainer");
      const gamificationToggle = document.getElementById("gamificationToggle");

      let currentPlanId;
      let currentPlan;
      let normalizedPlan;
      let selectedWeekId;
      let progressState;

      initTheme();

      // --- Exercise Modal Logic ---
      const exerciseModalBackdrop = document.getElementById("exerciseModalBackdrop");
      const exerciseModalTitle = document.getElementById("exerciseModalTitle");
      const exerciseModalBody = document.getElementById("exerciseModalBody");
      const exerciseModalClose = document.getElementById("exerciseModalClose");
      let lastFocusedElement = null;

      function openExerciseModal(exKey) {
          const exercise = currentPlan.exercises?.[exKey];
          if (!exercise) return;

          lastFocusedElement = document.activeElement;
          exerciseModalTitle.textContent = exKey;
          exerciseModalBody.innerHTML = "";

          // Image
          if (exercise.img) {
              const img = document.createElement("img");
              img.src = exercise.img;
              img.alt = exKey;
              img.className = "modal-image";
              img.onerror = () => {
                   img.style.display = 'none';
                   const err = document.createElement("div");
                   err.textContent = `Add image: ${exercise.img}`;
                   err.style.color = "var(--muted)";
                   err.style.fontSize = "12px";
                   err.style.marginBottom = "10px";
                   exerciseModalBody.insertBefore(err, exerciseModalBody.firstChild);
              };
              exerciseModalBody.append(img);
          }

          // Cues
          if (exercise.cues && exercise.cues.length) {
              const ul = document.createElement("ul");
              ul.className = "modal-cues";
              exercise.cues.forEach(cue => {
                  const li = document.createElement("li");
                  li.textContent = cue;
                  ul.append(li);
              });
              exerciseModalBody.append(ul);
          }

          // Note
          if (exercise.note) {
              const note = document.createElement("p");
              note.className = "modal-note";
              note.textContent = exercise.note;
              exerciseModalBody.append(note);
          }

          // Show
          exerciseModalBackdrop.hidden = false;
          // Trigger reflow/wait for next frame for transition
          requestAnimationFrame(() => {
              exerciseModalBackdrop.setAttribute("aria-hidden", "false");
          });

          document.body.style.overflow = "hidden";
          exerciseModalClose.focus();
      }

      function closeExerciseModal() {
          exerciseModalBackdrop.setAttribute("aria-hidden", "true");
          document.body.style.overflow = "";

          setTimeout(() => {
              if (exerciseModalBackdrop.getAttribute("aria-hidden") === "true") {
                  exerciseModalBackdrop.hidden = true;
              }
          }, 200);

          if (lastFocusedElement) {
              lastFocusedElement.focus();
          }
      }

      // Modal Listeners
      exerciseModalClose.addEventListener("click", closeExerciseModal);
      exerciseModalBackdrop.addEventListener("click", (e) => {
          if (e.target === exerciseModalBackdrop) closeExerciseModal();
      });
      document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && exerciseModalBackdrop.getAttribute("aria-hidden") === "false") {
              closeExerciseModal();
          }
           if (e.key === "Tab" && exerciseModalBackdrop.getAttribute("aria-hidden") === "false") {
               // Simple Focus Trap
                const focusable = exerciseModalBackdrop.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                if (focusable.length === 0) return;

                const first = focusable[0];
                const last = focusable[focusable.length - 1];

                if (e.shiftKey) {
                    if (document.activeElement === first) {
                        last.focus();
                        e.preventDefault();
                    }
                } else {
                    if (document.activeElement === last) {
                        first.focus();
                        e.preventDefault();
                    }
                }
           }
      });

      // Coach messages
      const COACH_MESSAGES = [
        "Strong week. Consistency beats everything.",
        "Great habits building.",
        "Speed stays sharp when effort stays smart.",
        "Focus on form, the results will follow.",
        "Showing up is the biggest win.",
        "Rest is when the muscles grow.",
        "Quality reps today, better athlete tomorrow."
      ];

      // Badges Definition
      const BADGES = [
        { id: "first_week", label: "First Week Completed", icon: "ðŸŸ¢", check: (stats) => stats.weeksCompleted >= 1 },
        { id: "three_weeks", label: "3 Weeks Consistent", icon: "ðŸ”µ", check: (stats) => stats.weeksCompleted >= 3 },
        { id: "strength_focus", label: "Strength Focus", icon: "ðŸŸ£", check: (stats) => stats.hasPerfectStrengthWeek },
        { id: "recovery_matters", label: "Recovery Matters", icon: "ðŸŸ¡", check: (stats) => stats.restDaysTaken >= 1 }
      ];

      function getDefaultPlanId() {
        const ids = Object.keys(PLANS);
        if (ids.length === 0) return "";
        const stored = localStorage.getItem(PLAN_KEY);
        if (stored && ids.includes(stored)) return stored;
        return ids[0];
      }

      function optionLabel(plan) {
        const { name, subtitle } = plan.meta;
        return subtitle ? `${name} â€” ${subtitle}` : name;
      }

      function populatePicker(activeId) {
        planPicker.innerHTML = "";
        Object.values(PLANS).forEach((plan) => {
          const option = document.createElement("option");
          option.value = plan.meta.id;
          option.textContent = optionLabel(plan);
          if (plan.meta.id === activeId) {
            option.selected = true;
          }
          planPicker.append(option);
        });
      }

      function populateWeekPicker(weeks, activeId) {
        weekPicker.innerHTML = "";

        weeks.forEach((week) => {
          const option = document.createElement("option");
          option.value = week.id;
          option.textContent = week.label;
          if (week.id === activeId) {
            option.selected = true;
          }
          weekPicker.append(option);
        });

        if (weeks.length <= 1) {
          weekPickerGroup.style.display = "none";
        } else {
          weekPickerGroup.style.display = "flex";
        }
      }

      function storageWeekKey(planId) {
        return `${WEEK_KEY_PREFIX}:${planId}`;
      }

      function renderBlockItems(listEl, items = []) {
        items.forEach((item) => {
          const li = document.createElement("li");
          let text = "";
          let exKey = null;

          if (typeof item === "string") {
            text = item;
          } else if (item && typeof item === "object") {
            text = item.text || item.ref || item.listRef || "";
            exKey = item.exKey;
          }

          if (!text) return;

          // Check if we can show media
          const exercise = (exKey && currentPlan.exercises) ? currentPlan.exercises[exKey] : null;

          if (exercise) {
              const div = document.createElement("div");
              div.className = "list-item-actionable";
              div.setAttribute("role", "button");
              div.setAttribute("tabindex", "0");
              div.setAttribute("aria-label", `View details for ${text}`);

              div.onclick = (e) => {
                  e.stopPropagation();
                  openExerciseModal(exKey);
              };
              div.onkeydown = (e) => {
                  if (e.key === "Enter" || e.key === " ") {
                      e.preventDefault();
                      openExerciseModal(exKey);
                  }
              };

              const spanText = document.createElement("span");
              spanText.className = "list-item-text";
              spanText.textContent = text;
              spanText.style.fontWeight = "600";

              const btnView = document.createElement("span");
              btnView.className = "view-chip";
              btnView.innerHTML = `View`;

              div.append(spanText, btnView);
              li.append(div);
          } else {
              li.textContent = text;
          }

          listEl.append(li);
        });
      }

      function renderPlan() {
        if (!normalizedPlan) return;

        // Dynamic Resolution for Template Plans (Isla)
        let displayData = normalizedPlan;
        if (currentPlan.meta.id === 'isla') {
            const weekNum = parseInt(selectedWeekId.replace('week-', ''));
            const view = resolvePlanForWeek(currentPlan, weekNum);

            // Construct a view object compatible with the renderer
            displayData = {
                meta: view.meta,
                overview: normalizedPlan.overview,
                weeks: [{
                    id: selectedWeekId,
                    label: view.weekLabel,
                    days: view.days
                }]
            };
        }

        planTitle.textContent = displayData.meta?.name || "";
        planSubtitle.textContent = displayData.meta?.subtitle || "";
        planSubtitle.style.display = displayData.meta?.subtitle ? "block" : "none";
        planOverview.textContent = displayData.overview || "";
        planOverview.style.display = displayData.overview ? "block" : "none";

        // Update Gamification
        updateGamification();

        weeksContainer.innerHTML = "";
        const weeks = displayData.weeks || [];
        const activeWeek = weeks.find((week) => week.id === selectedWeekId) || weeks[0];
        if (!activeWeek) return;

        const weekCard = document.createElement("section");
        weekCard.className = "week-container";

        const title = document.createElement("h3");
        title.className = "week-title";
        title.textContent = activeWeek.label || "Training Week";
        weekCard.append(title);

        const days = activeWeek.days || [];
        days.forEach((day, idx) => {
          const dayEl = document.createElement("article");
          dayEl.className = "day-card";

          // LEFT RAIL (Meta)
          const metaEl = document.createElement("div");
          metaEl.className = "day-meta";

          const header = document.createElement("header");
          header.className = "day-header";

          const nameEl = document.createElement("h4");
          nameEl.className = "day-name";
          const dayName = day.name || day.day || "Session";
          nameEl.textContent = dayName;

          header.append(nameEl);

          const dayTag = day.tag || day.tagTemplate;
          const dayId = day.id || day.day || day.name || `day-${idx + 1}`;
          const status = progressState?.completed?.includes(dayId)
            ? "Done"
            : progressState?.skipped?.includes(dayId)
              ? "Skipped"
              : "";

          // Status Badge
          if (dayTag || status) {
            const tagEl = document.createElement("div");
            tagEl.className = "day-tags";

            if (dayTag) {
                const badge = document.createElement("span");
                badge.className = "badge badge-tag";
                badge.textContent = dayTag;
                tagEl.append(badge);
            }
            if (status) {
                 const badge = document.createElement("span");
                badge.className = `badge badge-status-${status.toLowerCase()}`;
                badge.textContent = status;
                tagEl.append(badge);
            }
            header.append(tagEl);
          }

          metaEl.append(header);

          // CONTENT SECTION
          const contentEl = document.createElement("div");
          contentEl.className = "day-content";

          if (day.focus) {
            const focus = document.createElement("div");
            focus.className = "day-focus";
            const label = document.createElement("span");
            label.className = "focus-label";
            label.textContent = "Focus";
            const text = document.createElement("p");
            text.textContent = day.focus;
            focus.append(label, text);
            contentEl.append(focus);
          }

          if (Array.isArray(day.blocks) && day.blocks.length) {
            day.blocks.forEach((block) => {
              const blockWrapper = document.createElement("div");
              blockWrapper.className = "exercise-block";

              if (typeof block === "string") {
                const list = document.createElement("ul");
                const li = document.createElement("li");
                li.textContent = block;
                list.append(li);
                blockWrapper.append(list);
                contentEl.append(blockWrapper);
                return;
              }

              if (block && typeof block === "object") {
                 if (block.title) {
                  const titleEl = document.createElement("h5");
                  titleEl.className = "block-title";
                  titleEl.textContent = block.title;
                  blockWrapper.append(titleEl);
                }

                const list = document.createElement("ul");
                renderBlockItems(list, block.items);

                if (list.children.length > 0) {
                  blockWrapper.append(list);
                  contentEl.append(blockWrapper);
                }
              }
            });
          }

          // Controls moved to Meta in Left Rail
          const actionBar = document.createElement("div");
          actionBar.className = "day-actions";

          const doneBtn = document.createElement("button");
          doneBtn.className = "btn btn-primary";
          doneBtn.textContent = "Complete";
          doneBtn.setAttribute("aria-label", `Mark ${dayName} as done`);
          doneBtn.onclick = () => {
            setDayStatus(dayId, "done");
          };

          const skipBtn = document.createElement("button");
          skipBtn.className = "btn btn-ghost";
          skipBtn.textContent = "Skip";
          skipBtn.setAttribute("aria-label", `Skip ${dayName}`);
          skipBtn.onclick = () => {
            setDayStatus(dayId, "skipped");
          };

          if (status === "Done") {
            doneBtn.disabled = true;
            doneBtn.textContent = "Completed";
            dayEl.classList.add("is-complete");
          }

          if (status === "Skipped") {
            skipBtn.disabled = true;
            skipBtn.textContent = "Skipped";
             dayEl.classList.add("is-skipped");
          }

          actionBar.append(doneBtn, skipBtn);
          metaEl.append(actionBar);

          dayEl.append(metaEl, contentEl);
          weekCard.append(dayEl);
        });

        weeksContainer.append(weekCard);
      }

      function setDayStatus(dayId, status) {
        if (!progressState) return;
        const completed = new Set(progressState.completed || []);
        const skipped = new Set(progressState.skipped || []);

        completed.delete(dayId);
        skipped.delete(dayId);

        if (status === "done") {
          completed.add(dayId);
        } else if (status === "skipped") {
          skipped.add(dayId);
        }

        progressState = {
          completed: Array.from(completed),
          skipped: Array.from(skipped),
        };

        saveProgress(currentPlanId, selectedWeekId, progressState);
        renderPlan();
      }

      function setActiveWeek(weekId) {
        selectedWeekId = weekId;
        progressState = loadProgress(currentPlanId, selectedWeekId);
        localStorage.setItem(storageWeekKey(currentPlanId), selectedWeekId);
        renderPlan();
      }

      function setActivePlan(planId) {
        const plan = PLANS[planId];
        if (!plan) return;
        currentPlanId = planId;
        currentPlan = plan;
        normalizedPlan = normalizePlan(plan);

        // Ensure weeks exist for template plans
        if (plan.totalWeeks && (!plan.weeks || plan.weeks.length === 0)) {
            normalizedPlan.weeks = [];
            for (let i = 1; i <= plan.totalWeeks; i++) {
                normalizedPlan.weeks.push({
                    id: `week-${i}`,
                    label: `Week ${i}`,
                    days: [] // Content resolved in renderPlan
                });
            }
        }

        localStorage.setItem(PLAN_KEY, planId);
        populatePicker(planId);

        const weeks = normalizedPlan.weeks || [];
        const storedWeek = localStorage.getItem(storageWeekKey(planId));
        const defaultWeek = weeks[0]?.id;
        selectedWeekId = weeks.some((week) => week.id === storedWeek)
          ? storedWeek
          : defaultWeek;

        populateWeekPicker(weeks, selectedWeekId);
        setActiveWeek(selectedWeekId || defaultWeek);
      }

      // --- Gamification Logic ---

      function updateGamification() {
        // Detect Isla plan
        const isIslaPlan = currentPlan?.meta?.id === "isla";
        const storedToggle = localStorage.getItem(GAMIFY_TOGGLE_KEY);
        const isEnabled = storedToggle !== "false"; // Default true

        // Update toggle UI state
        gamificationToggle.checked = isEnabled;

        if (!isIslaPlan || !isEnabled) {
            gamificationDashboard.style.display = "none";
            return;
        }

        gamificationDashboard.style.display = "block";

        // Calculate Stats
        const stats = calculateStats();

        // Render Dashboard
        renderDashboard(stats);
      }

      function calculateStats() {
        if (!normalizedPlan) return {};

        let totalPoints = 0;
        let weeklyPoints = 0;
        let weekSessionsDone = 0;
        let weekSessionsTotal = 0;
        let weeksCompleted = 0;
        let hasPerfectStrengthWeek = false;
        let restDaysTaken = 0;

        // Determine which weeks to process
        let weeksToProcess = normalizedPlan.weeks;

        // Fix for Isla (Template Plan): Resolve weeks 1..Total to get actual days
        if (currentPlan.meta.id === 'isla' && currentPlan.totalWeeks) {
            weeksToProcess = [];
            for (let i = 1; i <= currentPlan.totalWeeks; i++) {
                const wId = `week-${i}`;
                // Resolve for week i
                const view = resolvePlanForWeek(currentPlan, i);
                weeksToProcess.push({
                    id: wId,
                    days: view.days // This now has the actual blocks/items
                });
            }
        }

        weeksToProcess.forEach(week => {
             const progress = loadProgress(currentPlanId, week.id) || { completed: [], skipped: [] };

             let weekPoints = 0;
             let weekDoneCount = 0;
             let weekPlanCount = week.days.length;

             // Count strength days in this week to check for "Strength Focus"
             // Isla's plan: Strength is Day 1 and Day 4.
             // We check if all days with focus "Strength..." are done.
             let weekStrengthTotal = 0;
             let weekStrengthDone = 0;

             week.days.forEach((day, idx) => {
                 // Identify Rest Day
                 const isRest = day.focus === "Rest";
                 const dayId = day.id || day.day || day.name || `day-${idx + 1}`;
                 const isDone = progress.completed.includes(dayId);

                 const isStrength = day.focus && day.focus.includes("Strength");

                 if (isStrength) {
                    weekStrengthTotal++;
                 }

                 if (isDone) {
                     if (isRest) {
                         weekPoints += 5;
                         restDaysTaken++;
                     } else {
                         weekPoints += 10;
                     }

                     if (isStrength) {
                        weekStrengthDone++;
                     }

                     weekDoneCount++;
                 }
             });

             if (weekStrengthTotal > 0 && weekStrengthDone === weekStrengthTotal) {
                hasPerfectStrengthWeek = true;
             }

             totalPoints += weekPoints;

             // If this is the currently selected week, update weekly stats
             if (week.id === selectedWeekId) {
                 weeklyPoints = weekPoints;
                 weekSessionsDone = weekDoneCount;
                 weekSessionsTotal = weekPlanCount;
             }

             // Prompt: "First Week Completed".
             // We use >= 40 points as a heuristic for a "completed" training week.
             if (weekPoints >= 40) {
                 weeksCompleted++;
             }
        });

        // Persist points as requested
        if (currentPlanId === "isla") {
            localStorage.setItem("points_v1:isla", totalPoints);
        }

        return {
            totalPoints,
            weeklyPoints,
            weekSessionsDone,
            weekSessionsTotal,
            weeksCompleted,
            hasPerfectStrengthWeek,
            restDaysTaken
        };
      }

      function renderDashboard(stats) {
          // Weekly Scorecard
          weeklyPointsEl.textContent = stats.weeklyPoints;
          sessionsCompletedEl.textContent = `${stats.weekSessionsDone}/${stats.weekSessionsTotal}`;

          // Coach Message (random but deterministic per day/week? Random is fine for now)
          if (!coachMessageEl.textContent || Math.random() > 0.8) {
             const msg = COACH_MESSAGES[Math.floor(Math.random() * COACH_MESSAGES.length)];
             coachMessageEl.textContent = `â€œ${msg}â€`;
          }

          // Progress Bar
          // Goal: 120 points = 12 weeks * 10 points/week??
          // Wait, 12 weeks * 10 points is very low.
          // Prompt says: "Goal: e.g. 120 points = 12 solid weeks".
          // Actually 10 points is 1 session.
          // If Isla does 4 sessions/week = 40 pts.
          // 12 weeks * 40 pts = 480 pts.
          // Maybe the prompt meant "120 points" as an arbitrary example.
          // Goal: 120 points (Season progress)
          const GOAL_POINTS = 120;
          const percentage = Math.min((stats.totalPoints / GOAL_POINTS) * 100, 100);
          totalProgressBar.style.width = `${percentage}%`;
          totalPointsLabel.textContent = `${stats.totalPoints} / ${GOAL_POINTS} pts`;

          // Badges
          renderBadges(stats);
      }

      function renderBadges(stats) {
          badgesContainer.innerHTML = "";

          // Retrieve stored badges
          const storedBadges = JSON.parse(localStorage.getItem(BADGES_KEY) || "[]");
          const newUnlocked = [];

          BADGES.forEach(badge => {
              const isUnlocked = storedBadges.includes(badge.id) || badge.check(stats);

              if (isUnlocked && !storedBadges.includes(badge.id)) {
                  newUnlocked.push(badge.id);
              }

              const badgeEl = document.createElement("div");
              badgeEl.className = `badge ${isUnlocked ? "unlocked" : ""}`;
              badgeEl.innerHTML = `<span class="badge-icon">${badge.icon}</span> ${badge.label}`;
              badgesContainer.append(badgeEl);
          });

          // Save new unlocks
          if (newUnlocked.length > 0) {
              const updated = [...storedBadges, ...newUnlocked];
              localStorage.setItem(BADGES_KEY, JSON.stringify(updated));
          }
      }

      // Toggle Event Listener
      gamificationToggle.addEventListener("change", (e) => {
          localStorage.setItem(GAMIFY_TOGGLE_KEY, e.target.checked);
          updateGamification();
      });

      // Initial
      const startingPlanId = getDefaultPlanId();
      setActivePlan(startingPlanId);

      planPicker.addEventListener("change", (event) => {
        setActivePlan(event.target.value);
      });

      weekPicker.addEventListener("change", (event) => {
        setActiveWeek(event.target.value);
      });
    </script>
  </body>
</html>
