<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Family Training Hub</title>
    <link rel="stylesheet" href="./themes.css" />
    
    <style>
      :root {
        --radius-sm: 10px;
        --radius-md: 16px;
        --radius-lg: 22px;
        --shadow-sm: 0 6px 20px rgb(0 0 0 / 0.05);
        --shadow-md: 0 12px 30px rgb(0 0 0 / 0.12);
        --shadow-lg: 0 16px 40px rgb(0 0 0 / 0.18);
        --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: var(--font-sans);
        background: var(--bg);
        background-attachment: fixed;
        color: var(--fg);
        -webkit-font-smoothing: antialiased;
        line-height: 1.6;
        position: relative;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background: var(--texture);
        opacity: 1;
        mix-blend-mode: normal;
        z-index: -1;
      }

      main {
        max-width: 1040px;
        margin: 0 auto;
        padding: 32px 18px 80px;
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .shell {
        background: linear-gradient(135deg, rgba(255,255,255,0.72), rgba(255,255,255,0.56));
        border: 1px solid var(--border);
        border-radius: 28px;
        box-shadow: var(--shadow-soft);
        padding: 24px;
        backdrop-filter: blur(12px);
      }

      .muted { color: var(--muted); font-size: 14px; font-weight: 500; }

      /* Hero */
      .hero {
        display: flex;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
        align-items: center;
      }

      .hero-left { display: flex; gap: 14px; align-items: center; }

      .plan-avatar {
        width: 60px;
        height: 60px;
        border-radius: 18px;
        background: linear-gradient(135deg, var(--accent), var(--accent-strong));
        color: #fff;
        display: grid;
        place-items: center;
        font-size: 26px;
        font-weight: 800;
        box-shadow: var(--shadow-md);
      }

      .title-stack h1 { margin: 0; font-size: 34px; letter-spacing: -0.03em; }
      .title-stack p { margin: 4px 0 0; font-weight: 600; color: var(--muted); }

      .hero-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

      /* Toggle switch */
      .toggle { display: inline-flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase; font-size: 12px; color: var(--muted); }
      .toggle input { display: none; }
      .switch {
        width: 56px;
        height: 30px;
        background: var(--border);
        border-radius: 999px;
        position: relative;
        transition: background 0.2s ease;
        box-shadow: inset 0 2px 6px rgb(0 0 0 / 0.08);
      }
      .switch::after {
        content: "";
        position: absolute;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--elevated);
        box-shadow: var(--shadow-sm);
        top: 3px;
        left: 3px;
        transition: transform 0.2s ease, background 0.2s ease;
      }
      .toggle input:checked + .switch {
        background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      }
      .toggle input:checked + .switch::after { transform: translateX(26px); background: #fff; }

      /* Today strip */
      .today-strip {
        margin-top: 14px;
        padding: 14px 16px;
        border-radius: 18px;
        border: 1px solid var(--border);
        background: linear-gradient(120deg, rgba(91, 123, 255, 0.12), rgba(255, 255, 255, 0.8));
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .today-title { font-weight: 800; font-size: 16px; letter-spacing: 0.02em; }

      /* Toolbar */
      .toolbar {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 16px;
        margin-top: 12px;
      }
      .toolbar-card {
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 14px 16px;
        background: var(--card);
        box-shadow: var(--shadow-sm);
      }
      .control-group { display: flex; flex-direction: column; gap: 8px; font-size: 11px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); font-weight: 800; }
      select {
        padding: 12px 14px;
        border: 1px solid var(--border);
        border-radius: 14px;
        background: var(--elevated);
        color: var(--fg);
        font-size: 15px;
        font-weight: 700;
        box-shadow: inset 0 1px 0 rgb(255 255 255 / 0.6), var(--shadow-sm);
        cursor: pointer;
        min-width: 170px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.15s ease;
        height: 46px;
      }
      select:hover { border-color: var(--accent); transform: translateY(-1px); }
      select:focus { outline: none; box-shadow: 0 0 0 3px rgba(91, 123, 255, 0.25), var(--shadow-sm); }

      /* Buttons */
      .btn {
        padding: 11px 18px;
        border: 1px solid transparent;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 800;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-width: 110px;
        height: 44px;
        box-shadow: var(--shadow-sm);
      }
      .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-strong)); color: #fff; }
      .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: var(--shadow-md); filter: brightness(1.03); }
      .btn-ghost { background: transparent; color: var(--fg); border: 1px solid var(--border); }
      .btn-ghost:hover:not(:disabled) { background: var(--card); box-shadow: var(--shadow-sm); }
      .btn-outline { background: var(--elevated); border: 1px solid var(--border); color: var(--fg); }
      .btn:disabled { opacity: 0.55; cursor: default; }
      .btn:focus-visible, select:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(92, 124, 255, 0.35), var(--shadow-sm); }

      /* Weekly progress */
      .weekly-progress {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: 12px;
        padding: 16px;
        border-radius: 18px;
        border: 1px solid var(--border);
        background: linear-gradient(120deg, rgba(91,123,255,0.1), rgba(255,255,255,0.85));
      }
      .weekly-progress .stat { display: flex; flex-direction: column; gap: 4px; }
      .weekly-progress .stat strong { font-size: 20px; }
      .progress-track { width: 100%; height: 10px; border-radius: 10px; background: rgba(0,0,0,0.06); overflow: hidden; }
      .progress-fill { height: 100%; width: 0; background: linear-gradient(90deg, var(--accent), var(--accent-strong)); border-radius: 10px; transition: width 0.4s ease; }

      /* Day chips */
      .day-chip-bar {
        display: flex;
        gap: 10px;
        overflow-x: auto;
        padding: 8px 2px 4px;
        scrollbar-width: thin;
      }
      .day-chip {
        min-width: 130px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--elevated);
        display: flex;
        flex-direction: column;
        gap: 6px;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      }
      .day-chip:hover { transform: translateY(-2px); box-shadow: var(--shadow-sm); }
      .day-chip.active { border-color: var(--accent); background: rgba(91,123,255,0.08); box-shadow: var(--shadow-sm); }
      .chip-top { display: flex; justify-content: space-between; align-items: center; font-weight: 800; }
      .chip-focus { color: var(--muted); font-size: 13px; }
      .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #cbd5e1; }
      .status-dot.done { background: #16a34a; }
      .status-dot.skipped { background: #f59e0b; }

      /* Week Container */
      .week-container { display: flex; flex-direction: column; gap: 16px; }
      .week-title { font-size: 22px; font-weight: 800; margin: 4px 0 0; letter-spacing: -0.02em; }

      /* Day Card */
      .day-card {
        background: var(--card);
        border-radius: 20px;
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--border);
        margin-bottom: 16px;
        padding: 20px 18px 18px;
        display: flex;
        flex-direction: column;
        gap: 14px;
        scroll-margin-top: 120px;
      }
      .day-card.is-complete { border-color: rgba(22, 163, 74, 0.35); }
      .day-card.is-skipped { border-color: rgba(245, 158, 11, 0.4); opacity: 0.9; }

      .day-header { display: flex; justify-content: space-between; gap: 10px; flex-wrap: wrap; align-items: center; }
      .day-title { margin: 0; font-size: 20px; font-weight: 800; letter-spacing: -0.02em; }
      .day-meta-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
      .pill { padding: 6px 12px; border-radius: 999px; border: 1px solid var(--border); font-size: 12px; font-weight: 800; letter-spacing: 0.05em; text-transform: uppercase; }
      .pill.done { background: rgba(22, 163, 74, 0.12); color: #166534; border-color: rgba(22,163,74,0.35); }
      .pill.skipped { background: rgba(245, 158, 11, 0.16); color: #92400e; border-color: rgba(245,158,11,0.35); }

      .variation-row { display: flex; gap: 8px; flex-wrap: wrap; }
      .chip { padding: 6px 10px; border-radius: 10px; background: rgba(0,0,0,0.05); color: var(--fg); font-weight: 700; font-size: 12px; border: 1px solid var(--border); }

      .day-progress { display: flex; align-items: center; gap: 10px; }
      .day-progress small { color: var(--muted); font-weight: 700; }
      .day-progress .progress-track { background: rgba(0,0,0,0.08); height: 8px; }

      .day-actions { display: flex; gap: 10px; flex-wrap: wrap; }

      /* Focus card */
      .day-focus { padding: 14px 16px; background: var(--elevated); border-radius: 14px; border: 1px solid var(--border); box-shadow: inset 0 1px 0 rgb(255 255 255 / 0.6); }
      .focus-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 800; color: var(--muted); }
      .day-focus p { margin: 4px 0 0; font-size: 15px; }

      /* Exercise blocks */
      .block-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
      .exercise-block { padding: 16px; background: var(--elevated); border: 1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow-sm); transition: transform 0.2s ease, box-shadow 0.2s ease; }
      .exercise-block:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
      .block-title { margin: 0 0 10px; display: flex; align-items: center; gap: 8px; font-size: 13px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); }
      .block-icon { font-size: 18px; }

      ul { list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: 8px; }
      li { color: var(--fg); font-size: 15px; line-height: 1.5; }
      .exercise-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 10px; border: 1px solid transparent; transition: background 0.2s ease, border-color 0.2s ease; cursor: default; }
      .exercise-row.actionable { cursor: pointer; border-color: var(--border); }
      .exercise-row.actionable:hover { background: rgba(91,123,255,0.08); }
      .view-chip { font-size: 12px; font-weight: 700; padding: 6px 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); display: inline-flex; align-items: center; gap: 6px; }

      /* Today anchor button */
      .anchor-btn { min-width: 140px; }

      /* Gamification Styles */
      .gamification-dashboard {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 22px 24px;
        margin-bottom: 20px;
        box-shadow: var(--shadow-sm);
        display: none; /* Hidden by default */
        animation: fadeIn 0.3s ease-out;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .scorecard-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
        flex-wrap: wrap;
        gap: 12px;
      }

      .scorecard-stats { display: flex; gap: 24px; }
      .stat-item { display: flex; flex-direction: column; }
      .stat-value { font-size: 24px; font-weight: 800; color: var(--accent); }
      .stat-label { font-size: 12px; color: var(--muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }

      .coach-message { font-style: italic; color: var(--fg); margin-top: 8px; font-size: 15px; border-left: 3px solid var(--accent); padding-left: 12px; max-width: 600px; }

      .badges-container { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }

      .gamification-dashboard .achievement-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; background: rgba(92, 124, 255, 0.1); color: var(--fg); border: 1px solid var(--border); }

      .competition-line { margin-top: 12px; font-size: 13px; color: var(--muted); font-weight: 700; }

      /* Modal Styles */
      .modal-backdrop { position: fixed; inset: 0; background: rgba(0, 7, 35, 0.35); backdrop-filter: blur(6px); display: grid; place-items: center; z-index: 999; padding: 18px; transition: opacity 0.2s ease; }
      .modal { background: var(--card); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); border: 1px solid var(--border); max-width: 560px; width: 100%; max-height: 90vh; overflow: hidden; }

      .modal-body { padding: 18px 20px 8px; overflow-y: auto; max-height: 60vh; }
      .modal-header { padding: 18px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); background: linear-gradient(120deg, rgba(92, 124, 255, 0.06), transparent); }
      .modal-header h2 { margin: 0; font-size: 20px; }
      .btn-icon { background: transparent; border: 1px solid var(--border); width: 36px; height: 36px; border-radius: 10px; cursor: pointer; transition: transform 0.2s ease; font-size: 15px; }
      .btn-icon:hover { transform: translateY(-1px); }
      .modal-body p { margin: 0 0 12px; color: var(--fg); font-size: 15px; line-height: 1.5; }
      .modal-note { background: var(--bg); padding: 12px 16px; border-radius: var(--radius-md); font-style: italic; color: var(--muted); border-left: 3px solid var(--accent); margin: 0; font-size: 14px; }
      .modal-footer { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-top: 1px solid var(--border); background: var(--bg); border-bottom-left-radius: var(--radius-lg); border-bottom-right-radius: var(--radius-lg); }

      /* Toast */
      .toast { position: fixed; bottom: 20px; right: 20px; background: var(--elevated); padding: 12px 16px; border-radius: 12px; box-shadow: var(--shadow-lg); border: 1px solid var(--border); display: none; align-items: center; gap: 8px; font-weight: 700; z-index: 1000; }

      /* Confetti */
      .confetti { position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 999; }
      .confetti span { position: absolute; width: 8px; height: 14px; background: var(--accent); opacity: 0.8; animation: fall 1s ease-out forwards; }
      @keyframes fall { to { transform: translateY(220px) rotate(240deg); opacity: 0; } }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .hero { gap: 12px; }
        .hero-actions { width: 100%; justify-content: flex-start; }
        .toolbar { grid-template-columns: 1fr; }
        .weekly-progress { grid-template-columns: 1fr; }
        .day-actions { width: 100%; }
        .day-actions .btn { flex: 1; }
        .day-card { padding: 18px 14px; }
        .block-grid { grid-template-columns: 1fr; }
        .today-strip { flex-direction: column; align-items: flex-start; }
      }
    </style>

  </head>
  <body>
    <!-- Modal Scaffold -->
    <div class="modal-backdrop" id="exerciseModalBackdrop" role="dialog" aria-modal="true" aria-hidden="true" hidden>
      <div class="modal" role="document">
        <div class="modal-header">
          <h2 id="exerciseModalTitle"></h2>
          <button id="exerciseModalClose" aria-label="Close" class="btn-icon">‚úï</button>
        </div>
        <div class="modal-body" id="exerciseModalBody"></div>
        <div class="modal-footer" id="exerciseModalFooter">
            <button id="exerciseModalPrev" class="btn btn-ghost" aria-label="Previous exercise">‚Üê Prev</button>
            <span id="exerciseModalCounter" class="muted" style="font-size: 13px; font-weight: 500;"></span>
            <button id="exerciseModalNext" class="btn btn-primary" aria-label="Next exercise">Next ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- Coach Bonus Modal -->
    <div class="modal-backdrop" id="coachBonusModalBackdrop" role="dialog" aria-modal="true" aria-hidden="true" hidden>
      <div class="modal" role="document" style="max-width: 400px;">
        <div class="modal-header">
          <h2 id="coachBonusTitle">Session Complete</h2>
          <button id="coachBonusClose" aria-label="Close" class="btn-icon">‚úï</button>
        </div>
        <div class="modal-body">
          <p class="muted" style="margin-top: 0; margin-bottom: 20px;">Did you stick to the plan?</p>
          <div style="display: flex; flex-direction: column; gap: 12px;">
             <button class="btn btn-primary" id="btnBonusSharp">Stopped while still sharp (+5)</button>
             <button class="btn btn-primary" id="btnBonusFocus">Great focus today (+5)</button>
             <button class="btn btn-ghost" id="btnBonusSkip">Just got it done</button>
          </div>
        </div>
      </div>
    </div>

        <main>
      <div class="shell">
        <div class="hero">
          <div class="hero-left">
            <div id="planAvatar" class="plan-avatar">üèÉ‚Äç‚ôÇÔ∏è</div>
            <div class="title-stack">
              <p class="muted">Family Training Hub</p>
              <h1 id="planTitle"></h1>
              <p id="planSubtitle" class="muted"></p>
            </div>
          </div>
          <div class="hero-actions">
            <label class="toggle" for="themeToggle">
              <input type="checkbox" id="themeToggle" />
              <span class="switch"></span>
              <span>Dark</span>
            </label>
            <button id="resetProgress" class="btn btn-outline">Reset week</button>
          </div>
        </div>

        <p id="planOverview" class="muted" style="margin: 10px 0 0;"></p>

        <div class="today-strip">
          <div>
            <div class="today-title" id="todayLabel">Today: Day 1 ¬∑ Let's get moving</div>
            <div class="muted" id="todayMessage">Scroll to the session and press Start.</div>
          </div>
          <button id="startToday" class="btn btn-primary anchor-btn">Start</button>
        </div>

        <div class="weekly-progress" id="weeklyProgress">
          <div class="stat">
            <span class="muted">This week</span>
            <strong id="weeklyCount">0 / 7 sessions</strong>
            <span id="weeklyMessage" class="muted">Let's start easy.</span>
          </div>
          <div class="progress-track"><div id="weeklyBar" class="progress-fill"></div></div>
        </div>

        <div class="toolbar">
          <div class="toolbar-card">
            <div class="control-group">
              <label for="planPicker">Plan</label>
              <select id="planPicker"></select>
            </div>
          </div>
          <div class="toolbar-card" id="weekPickerGroup">
            <div class="control-group">
              <label for="weekPicker">Week</label>
              <select id="weekPicker"></select>
            </div>
          </div>
        </div>

        <div class="day-chip-bar" id="dayChips"></div>

        <!-- Gamification Dashboard -->
        <section id="gamificationDashboard" class="gamification-dashboard">
          <div class="scorecard-header">
            <div class="scorecard-stats">
              <div class="stat-item">
                <span id="weeklyPoints" class="stat-value">0</span>
                <span class="stat-label">This Week</span>
              </div>
              <div class="stat-item">
                <span id="sessionsCompleted" class="stat-value">0/0</span>
                <span class="stat-label">Sessions</span>
              </div>
            </div>
            <div id="coachMessage" class="coach-message"></div>
          </div>

          <div class="progress-section">
            <div class="progress-label">
              <span>Training Blocks Completed</span>
              <span id="totalPointsLabel">0 / 120 pts</span>
            </div>
            <div class="progress-track">
              <div id="totalProgressBar" class="progress-fill"></div>
            </div>
          </div>

          <div id="badgesContainer" class="badges-container"></div>

          <div class="competition-line">
             You vs You ‚Äî Quality over quantity.
          </div>

           <label class="toggle gamification-toggle-label">
              <input type="checkbox" id="gamificationToggle" checked />
              <span class="muted">Show achievements</span>
          </label>
        </section>

        <section id="weeks" class="weeks"></section>
      </div>
    </main>

    <script type="module">
      import { PLANS } from "./plans/index.js";
      import { normalizePlan } from "./plans/adapter.js";
      import { resolvePlanForWeek } from "./plans/resolve.js";
      import { loadProgress, saveProgress } from "./progress.js";
      import { initTheme } from "./theme.js";

      const PLAN_KEY = "selected_plan_v1";
      const WEEK_KEY_PREFIX = "selected_week_v1";
      const GAMIFY_TOGGLE_KEY = "isla_gamify_enabled_v1";
      const BADGES_KEY = "badges_v1:isla";

      const planPicker = document.getElementById("planPicker");
      const planTitle = document.getElementById("planTitle");
      const planSubtitle = document.getElementById("planSubtitle");
      const planOverview = document.getElementById("planOverview");
      const planAvatar = document.getElementById("planAvatar");
      const weekPicker = document.getElementById("weekPicker");
      const weekPickerGroup = document.getElementById("weekPickerGroup");
      const weeksContainer = document.getElementById("weeks");
      const dayChips = document.getElementById("dayChips");
      const startTodayBtn = document.getElementById("startToday");
      const resetProgressBtn = document.getElementById("resetProgress");
      const todayLabel = document.getElementById("todayLabel");
      const todayMessage = document.getElementById("todayMessage");
      const weeklyCountEl = document.getElementById("weeklyCount");
      const weeklyBarEl = document.getElementById("weeklyBar");
      const weeklyMessageEl = document.getElementById("weeklyMessage");
      const toastEl = document.getElementById("toast");
      const confettiEl = document.getElementById("confetti");

      // Gamification Elements
      const gamificationDashboard = document.getElementById("gamificationDashboard");
      const weeklyPointsEl = document.getElementById("weeklyPoints");
      const sessionsCompletedEl = document.getElementById("sessionsCompleted");
      const coachMessageEl = document.getElementById("coachMessage");
      const totalProgressBar = document.getElementById("totalProgressBar");
      const totalPointsLabel = document.getElementById("totalPointsLabel");
      const badgesContainer = document.getElementById("badgesContainer");
      const gamificationToggle = document.getElementById("gamificationToggle");

      let currentPlanId;
      let currentPlan;
      let normalizedPlan;
      let selectedWeekId;
      let progressState;
      let todayTargetId = null;

      initTheme();

      // --- Exercise Modal Logic ---
      const exerciseModalBackdrop = document.getElementById("exerciseModalBackdrop");
      const exerciseModalTitle = document.getElementById("exerciseModalTitle");
      const exerciseModalBody = document.getElementById("exerciseModalBody");
      const exerciseModalClose = document.getElementById("exerciseModalClose");
      const exerciseModalPrev = document.getElementById("exerciseModalPrev");
      const exerciseModalNext = document.getElementById("exerciseModalNext");
      const exerciseModalCounter = document.getElementById("exerciseModalCounter");
      let lastFocusedElement = null;

      // Coach Bonus Elements
      const coachBonusModalBackdrop = document.getElementById("coachBonusModalBackdrop");
      const coachBonusClose = document.getElementById("coachBonusClose");
      const btnBonusSharp = document.getElementById("btnBonusSharp");
      const btnBonusFocus = document.getElementById("btnBonusFocus");
      const btnBonusSkip = document.getElementById("btnBonusSkip");
      let coachBonusLastFocused = null;
      let pendingBonusDayId = null;

      let modalState = {
        exKeys: [],
        index: 0
      };

      function openExerciseModal(exKey, triggerElement) {
          // Capture context
          if (triggerElement) {
              const dayCard = triggerElement.closest('.day-card');
              if (dayCard && dayCard.dataset.exkeys) {
                  const keys = dayCard.dataset.exkeys.split('|');
                  const idx = keys.indexOf(exKey);
                  modalState = { exKeys: keys, index: idx !== -1 ? idx : 0 };
              } else {
                   modalState = { exKeys: [exKey], index: 0 };
              }
          } else {
              // Fallback or external call
              modalState = { exKeys: [exKey], index: 0 };
          }

          lastFocusedElement = document.activeElement;
          renderExerciseInModal(exKey);

          // Show
          exerciseModalBackdrop.hidden = false;
          requestAnimationFrame(() => {
              exerciseModalBackdrop.setAttribute("aria-hidden", "false");
          });

          document.body.style.overflow = "hidden";

          // Manage focus
          exerciseModalClose.focus();
      }

      function renderExerciseInModal(exKey) {
          const exercise = currentPlan.exercises?.[exKey];
          if (!exercise) return;

          exerciseModalTitle.textContent = exKey;
          exerciseModalBody.innerHTML = "";

          // Image
          if (exercise.img) {
              const img = document.createElement("img");
              img.src = exercise.img;
              img.alt = exKey;
              img.className = "modal-image";
              img.onerror = () => {
                   img.style.display = 'none';
                   const err = document.createElement("div");
                   err.textContent = `Add image: ${exercise.img}`;
                   err.style.color = "var(--muted)";
                   err.style.fontSize = "12px";
                   err.style.marginBottom = "10px";
                   exerciseModalBody.insertBefore(err, exerciseModalBody.firstChild);
              };
              exerciseModalBody.append(img);
          }

          // Cues
          if (exercise.cues && exercise.cues.length) {
              const ul = document.createElement("ul");
              ul.className = "modal-cues";
              exercise.cues.forEach(cue => {
                  const li = document.createElement("li");
                  li.textContent = cue;
                  ul.append(li);
              });
              exerciseModalBody.append(ul);
          }

          // Note
          if (exercise.note) {
              const note = document.createElement("p");
              note.className = "modal-note";
              note.textContent = exercise.note;
              exerciseModalBody.append(note);
          }

          updateModalControls();
      }

      function updateModalControls() {
          const { index, exKeys } = modalState;
          const count = exKeys.length;

          exerciseModalCounter.textContent = `${index + 1} / ${count}`;

          const disabled = count <= 1;
          exerciseModalPrev.disabled = disabled;
          exerciseModalNext.disabled = disabled;
      }

      function nextExercise() {
          if (modalState.exKeys.length <= 1) return;
          let newIndex = modalState.index + 1;
          if (newIndex >= modalState.exKeys.length) newIndex = 0;

          modalState.index = newIndex;
          renderExerciseInModal(modalState.exKeys[newIndex]);
      }

      function prevExercise() {
          if (modalState.exKeys.length <= 1) return;
          let newIndex = modalState.index - 1;
          if (newIndex < 0) newIndex = modalState.exKeys.length - 1;

          modalState.index = newIndex;
          renderExerciseInModal(modalState.exKeys[newIndex]);
      }

      function closeExerciseModal() {
          exerciseModalBackdrop.setAttribute("aria-hidden", "true");
          document.body.style.overflow = "";

          setTimeout(() => {
              if (exerciseModalBackdrop.getAttribute("aria-hidden") === "true") {
                  exerciseModalBackdrop.hidden = true;
              }
          }, 200);

          if (lastFocusedElement) {
              lastFocusedElement.focus();
          }
      }

      // Modal Listeners
      exerciseModalPrev.onclick = prevExercise;
      exerciseModalNext.onclick = nextExercise;

      exerciseModalClose.addEventListener("click", closeExerciseModal);
      exerciseModalBackdrop.addEventListener("click", (e) => {
          if (e.target === exerciseModalBackdrop) closeExerciseModal();
      });
      document.addEventListener("keydown", (e) => {
          const isOpen = exerciseModalBackdrop.getAttribute("aria-hidden") === "false";
          if (!isOpen) return;

          if (e.key === "Escape") {
              closeExerciseModal();
          } else if (e.key === "ArrowRight") {
              nextExercise();
          } else if (e.key === "ArrowLeft") {
              prevExercise();
          } else if (e.key === "Tab") {
               // Simple Focus Trap
                const focusable = exerciseModalBackdrop.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                if (focusable.length === 0) return;

                const first = focusable[0];
                const last = focusable[focusable.length - 1];

                if (e.shiftKey) {
                    if (document.activeElement === first) {
                        last.focus();
                        e.preventDefault();
                    }
                } else {
                    if (document.activeElement === last) {
                        first.focus();
                        e.preventDefault();
                    }
                }
           }
      });

      // --- Coach Bonus Logic ---
      function openCoachBonusModal(dayId) {
          pendingBonusDayId = dayId;
          coachBonusLastFocused = document.activeElement;
          coachBonusModalBackdrop.hidden = false;
          coachBonusModalBackdrop.setAttribute("aria-hidden", "false");
          btnBonusSharp.focus();
      }

      function closeCoachBonusModal() {
          if (coachBonusLastFocused && typeof coachBonusLastFocused.focus === "function") {
              coachBonusLastFocused.focus();
          }
          coachBonusModalBackdrop.setAttribute("aria-hidden", "true");
          setTimeout(() => {
             if (coachBonusModalBackdrop.getAttribute("aria-hidden") === "true") {
                coachBonusModalBackdrop.hidden = true;
             }
          }, 200);
          coachBonusLastFocused = null;
          pendingBonusDayId = null;
      }

      function applyCoachBonus(reason) {
          if (!pendingBonusDayId) return;

          // Add bonus to progress
          const bonuses = progressState.bonuses || {};
          bonuses[pendingBonusDayId] = { points: 5, reason };
          progressState.bonuses = bonuses;

          saveProgress(currentPlanId, selectedWeekId, progressState);
          renderPlan(); // Update points

          closeCoachBonusModal();
      }

      coachBonusClose.onclick = closeCoachBonusModal;
      btnBonusSkip.onclick = closeCoachBonusModal;
      btnBonusSharp.onclick = () => applyCoachBonus("sharp");
      btnBonusFocus.onclick = () => applyCoachBonus("focus");

      // Coach messages
      const COACH_MESSAGES = [
        "Strong week. Quality beats quantity.",
        "Great habits building.",
        "Speed stays sharp when effort stays smart.",
        "Focus on form, the results will follow.",
        "Better to stop early than practice bad habits.",
        "Rest is when the muscles grow.",
        "Quality reps today, better athlete tomorrow."
      ];

      // Badges Definition
      const BADGES = [
        { id: "first_week", label: "First Week Completed", icon: "üü¢", check: (stats) => stats.weeksCompleted >= 1 },
        { id: "three_weeks", label: "3 Weeks Consistent", icon: "üîµ", check: (stats) => stats.weeksCompleted >= 3 },
        { id: "strength_focus", label: "Strength Focus", icon: "üü£", check: (stats) => stats.hasPerfectStrengthWeek },
        { id: "recovery_matters", label: "Recovery Matters", icon: "üü°", check: (stats) => stats.restDaysTaken >= 1 }
      ];

      function getDefaultPlanId() {
        const ids = Object.keys(PLANS);
        if (ids.length === 0) return "";
        const stored = localStorage.getItem(PLAN_KEY);
        if (stored && ids.includes(stored)) return stored;
        return ids[0];
      }

      function optionLabel(plan) {
        const { name, subtitle } = plan.meta;
        return subtitle ? `${name} ‚Äî ${subtitle}` : name;
      }

      function populatePicker(activeId) {
        planPicker.innerHTML = "";
        Object.values(PLANS).forEach((plan) => {
          const option = document.createElement("option");
          option.value = plan.meta.id;
          option.textContent = optionLabel(plan);
          if (plan.meta.id === activeId) {
            option.selected = true;
          }
          planPicker.append(option);
        });
      }

      function populateWeekPicker(weeks, activeId) {
        weekPicker.innerHTML = "";

        weeks.forEach((week) => {
          const option = document.createElement("option");
          option.value = week.id;
          option.textContent = week.label;
          if (week.id === activeId) {
            option.selected = true;
          }
          weekPicker.append(option);
        });

        if (weeks.length <= 1) {
          weekPickerGroup.style.display = "none";
        } else {
          weekPickerGroup.style.display = "flex";
        }
      }

      function storageWeekKey(planId) {
        return `${WEEK_KEY_PREFIX}:${planId}`;
      }

      function renderBlockItems(listEl, items = []) {
        items.forEach((item) => {
          const li = document.createElement("li");
          let text = "";
          let exKey = null;

          if (typeof item === "string") {
            text = item;
          } else if (item && typeof item === "object") {
            text = item.text || item.ref || item.listRef || "";
            exKey = item.exKey;
          }

          if (!text) return;

          // Check if we can show media
          const exercise = (exKey && currentPlan.exercises) ? currentPlan.exercises[exKey] : null;

          if (exercise) {
            li.className = "exercise-row actionable";
            li.setAttribute("role", "button");
            li.setAttribute("tabindex", "0");
            li.setAttribute("aria-label", `View details for ${text}`);

            const spanText = document.createElement("span");
            spanText.textContent = text;
            spanText.style.fontWeight = "600";

            const btnView = document.createElement("span");
            btnView.className = "view-chip";
            btnView.innerHTML = `üëÅ Details`;

            li.append(spanText, btnView);

            const open = () => openExerciseModal(exKey, li);
            li.onclick = (e) => {
              e.stopPropagation();
              open();
            };
            li.onkeydown = (e) => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                open();
              }
            };
          } else {
            li.className = "exercise-row";
            li.textContent = text;
          }

          listEl.append(li);
        });
      }

      function renderPlan() {
        if (!normalizedPlan) return;

        // Dynamic Resolution for Template Plans (Isla)
        let displayData = normalizedPlan;
        if (currentPlan.meta.id === 'isla') {
            const weekNum = parseInt(selectedWeekId.replace('week-', ''));
            const view = resolvePlanForWeek(currentPlan, weekNum);

            displayData = {
                meta: view.meta,
                overview: normalizedPlan.overview,
                weeks: [{
                    id: selectedWeekId,
                    label: view.weekLabel,
                    days: view.days
                }]
            };
        }

        const planName = displayData.meta?.name || "";
        planTitle.textContent = planName;
        planSubtitle.textContent = displayData.meta?.subtitle || "";
        planSubtitle.style.display = displayData.meta?.subtitle ? "block" : "none";
        planOverview.textContent = displayData.overview || "";
        planOverview.style.display = displayData.overview ? "block" : "none";
        planAvatar.textContent = displayData.meta?.emoji || (planName ? planName.charAt(0) : 'üèÉ');

        // Update Gamification
        updateGamification();

        weeksContainer.innerHTML = "";
        dayChips.innerHTML = "";
        const weeks = displayData.weeks || [];
        const activeWeek = weeks.find((week) => week.id === selectedWeekId) || weeks[0];
        if (!activeWeek) return;

        const weekCard = document.createElement("section");
        weekCard.className = "week-container";

        const title = document.createElement("h3");
        title.className = "week-title";
        title.textContent = activeWeek.label || "Training Week";
        weekCard.append(title);

        const days = activeWeek.days || [];
        const dayTargets = [];
        let firstOpenTarget = null;

        const completedCount = (progressState?.completed || []).length;
        const totalCount = days.length || 1;
        weeklyCountEl.textContent = `${completedCount} / ${totalCount} sessions`;
        const completionRatio = Math.min(100, Math.round((completedCount / totalCount) * 100));
        weeklyBarEl.style.width = `${completionRatio}%`;
        let coachLine = "Let's start easy.";
        if (completedCount >= 7) coachLine = "Perfect week!";
        else if (completedCount >= 4) coachLine = "Strong week.";
        else if (completedCount >= 1) coachLine = "Nice momentum.";
        weeklyMessageEl.textContent = coachLine;

        days.forEach((day, idx) => {
          const dayId = day.id || day.day || day.name || `day-${idx + 1}`;
          const dayDomId = `day-${idx + 1}`;
          const status = progressState?.completed?.includes(dayId)
            ? "Done"
            : progressState?.skipped?.includes(dayId)
              ? "Skipped"
              : "";

          const focusLabel = day.focus || day.tag || day.name || `Day ${idx + 1}`;

          const chip = document.createElement("div");
          chip.className = "day-chip";
          chip.dataset.target = dayDomId;
          const dot = document.createElement("span");
          dot.className = `status-dot ${status ? status.toLowerCase() : ""}`;
          const top = document.createElement("div");
          top.className = "chip-top";
          top.innerHTML = `<span>Day ${idx + 1}</span>`;
          top.append(dot);
          const focus = document.createElement("div");
          focus.className = "chip-focus";
          focus.textContent = focusLabel;
          chip.append(top, focus);
          chip.onclick = () => {
            const target = document.getElementById(dayDomId);
            if (target) {
              target.scrollIntoView({ behavior: "smooth", block: "start" });
              highlightActiveChip(dayDomId);
            }
          };
          dayChips.append(chip);

          if (!status && !firstOpenTarget) firstOpenTarget = dayDomId;
          dayTargets.push({ domId: dayDomId, chip });
        });

        todayTargetId = firstOpenTarget || (dayTargets[dayTargets.length - 1]?.domId || null);
        const todayDay = dayTargets.find(({ domId }) => domId === todayTargetId) || dayTargets[0];
        if (todayDay) {
          const idx = dayTargets.indexOf(todayDay);
          const focus = days[idx]?.focus || days[idx]?.name || `Day ${idx + 1}`;
          todayLabel.textContent = `Today: Day ${idx + 1} ¬∑ ${focus}`;
          todayMessage.textContent = coachLine;
          highlightActiveChip(todayDay.domId);
        }

        const iconFor = (title = "") => {
          const t = title.toLowerCase();
          if (t.includes("warm")) return "üî•";
          if (t.includes("main") || t.includes("strength")) return "üí™";
          if (t.includes("skill") || t.includes("focus")) return "üéØ";
          if (t.includes("cool") || t.includes("finish") || t.includes("stretch")) return "üßä";
          return "üèÉ";
        };

        days.forEach((day, idx) => {
          const dayId = day.id || day.day || day.name || `day-${idx + 1}`;
          const dayDomId = `day-${idx + 1}`;
          const dayName = day.name || day.day || `Day ${idx + 1}`;
          const status = progressState?.completed?.includes(dayId)
            ? "Done"
            : progressState?.skipped?.includes(dayId)
              ? "Skipped"
              : "Planned";

          const dayEl = document.createElement("article");
          dayEl.className = "day-card";
          dayEl.id = dayDomId;

          // Collect Exercise Keys for Context
          const dayExKeys = [];
          if (Array.isArray(day.blocks)) {
              day.blocks.forEach(block => {
                  const items = (typeof block === 'object' && block.items) ? block.items : [];
                  items.forEach(item => {
                     const k = (typeof item === 'object') ? item.exKey : null;
                     if (k && currentPlan.exercises?.[k] && !dayExKeys.includes(k)) {
                         dayExKeys.push(k);
                     }
                  });
              });
          }
          if (dayExKeys.length > 0) {
              dayEl.dataset.exkeys = dayExKeys.join('|');
          }

          const header = document.createElement("div");
          header.className = "day-header";

          const nameEl = document.createElement("h4");
          nameEl.className = "day-title";
          nameEl.textContent = dayName;

          const metaRow = document.createElement("div");
          metaRow.className = "day-meta-row";
          if (day.focus) {
            const focusPill = document.createElement("span");
            focusPill.className = "pill";
            focusPill.textContent = day.focus;
            metaRow.append(focusPill);
          }
          const statusPill = document.createElement("span");
          statusPill.className = `pill ${status.toLowerCase()}`;
          statusPill.textContent = status;
          metaRow.append(statusPill);

          header.append(nameEl, metaRow);
          dayEl.append(header);

          const variationRow = document.createElement("div");
          variationRow.className = "variation-row";
          const dayTag = day.tag || day.tagTemplate;
          if (dayTag) {
            const tagChip = document.createElement("span");
            tagChip.className = "chip";
            tagChip.textContent = dayTag;
            variationRow.append(tagChip);
          }
          if (day.base) {
            const baseChip = document.createElement("span");
            baseChip.className = "chip";
            baseChip.textContent = day.base;
            variationRow.append(baseChip);
          }
          if (variationRow.children.length) {
            dayEl.append(variationRow);
          }

          const progressRow = document.createElement("div");
          progressRow.className = "day-progress";
          const track = document.createElement("div");
          track.className = "progress-track";
          const fill = document.createElement("div");
          fill.className = "progress-fill";
          fill.style.width = status === 'Done' ? '100%' : status === 'Skipped' ? '40%' : '20%';
          track.append(fill);
          const small = document.createElement("small");
          small.textContent = status === 'Planned' ? 'Ready' : status;
          progressRow.append(track, small);
          dayEl.append(progressRow);

          if (day.focus) {
            const focus = document.createElement("div");
            focus.className = "day-focus";
            const label = document.createElement("span");
            label.className = "focus-label";
            label.textContent = "Focus";
            const text = document.createElement("p");
            text.textContent = day.focus;
            focus.append(label, text);
            dayEl.append(focus);
          }

          const contentEl = document.createElement("div");
          contentEl.className = "block-grid";

          if (Array.isArray(day.blocks) && day.blocks.length) {
            day.blocks.forEach((block) => {
              const blockWrapper = document.createElement("div");
              blockWrapper.className = "exercise-block";

              if (typeof block === "string") {
                const titleEl = document.createElement("h5");
                titleEl.className = "block-title";
                titleEl.innerHTML = `<span class="block-icon">üèÉ</span>${block}`;
                blockWrapper.append(titleEl);
                contentEl.append(blockWrapper);
                return;
              }

              if (block && typeof block === "object") {
                 if (block.title || block.time) {
                  const titleEl = document.createElement("h5");
                  titleEl.className = "block-title";
                  const baseTitle = block.title || "Session";
                  const label = block.time ? `${baseTitle} ¬∑ ${block.time}` : baseTitle;
                  titleEl.innerHTML = `<span class="block-icon">${iconFor(baseTitle)}</span>${label}`;
                  blockWrapper.append(titleEl);
                }

                const list = document.createElement("ul");
                renderBlockItems(list, block.items);

                if (list.children.length > 0) {
                  blockWrapper.append(list);
                  contentEl.append(blockWrapper);
                }
              }
            });
          }

          if (contentEl.children.length) {
            dayEl.append(contentEl);
          }

          const actionBar = document.createElement("div");
          actionBar.className = "day-actions";

          const doneBtn = document.createElement("button");
          doneBtn.className = "btn btn-primary";
          doneBtn.textContent = status === 'Done' ? 'Completed' : 'Mark done';
          doneBtn.setAttribute("aria-label", `Mark ${dayName} as done`);
          doneBtn.disabled = status === 'Done';
          doneBtn.onclick = () => {
            setDayStatus(dayId, "done");
            if (currentPlan.meta.id === 'isla') {
                openCoachBonusModal(dayId);
            }
          };

          const skipBtn = document.createElement("button");
          skipBtn.className = "btn btn-outline";
          skipBtn.textContent = status === 'Skipped' ? 'Missed' : 'Missed';
          skipBtn.setAttribute("aria-label", `Skip ${dayName}`);
          skipBtn.disabled = status === 'Skipped';
          skipBtn.onclick = () => {
            setDayStatus(dayId, "skipped");
          };

          const clearBtn = document.createElement("button");
          clearBtn.className = "btn btn-ghost";
          clearBtn.textContent = "Clear";
          clearBtn.onclick = () => setDayStatus(dayId, "clear");

          actionBar.append(doneBtn, skipBtn, clearBtn);
          dayEl.append(actionBar);

          if (status === "Done") {
            dayEl.classList.add("is-complete");
          }

          if (status === "Skipped") {
             dayEl.classList.add("is-skipped");
          }

          weekCard.append(dayEl);
        });

        weeksContainer.append(weekCard);
      }

      function showToast(message) {
        if (!toastEl) return;
        toastEl.textContent = message;
        toastEl.style.display = "flex";
        setTimeout(() => {
          toastEl.style.display = "none";
        }, 1600);
      }

      function triggerConfetti() {
        if (!confettiEl) return;
        confettiEl.innerHTML = "";
        for (let i = 0; i < 18; i++) {
          const piece = document.createElement("span");
          piece.style.left = `${Math.random() * 100}%`;
          piece.style.top = `${Math.random() * 10}%`;
          piece.style.background = i % 2 === 0 ? "#5b7bff" : "#f59e0b";
          piece.style.animationDelay = `${Math.random() * 0.2}s`;
          confettiEl.append(piece);
        }
        setTimeout(() => { confettiEl.innerHTML = ""; }, 1200);
      }

      function highlightActiveChip(domId) {
        document.querySelectorAll('.day-chip').forEach((chip) => {
          chip.classList.toggle('active', chip.dataset.target === domId);
        });
      }

      function setDayStatus(dayId, status) {
        if (!progressState) return;
        const completed = new Set(progressState.completed || []);
        const skipped = new Set(progressState.skipped || []);

        completed.delete(dayId);
        skipped.delete(dayId);

        if (status === "done") {
          completed.add(dayId);
        } else if (status === "skipped") {
          skipped.add(dayId);
        }

        progressState = {
          ...progressState,
          completed: Array.from(completed),
          skipped: Array.from(skipped),
        };

        saveProgress(currentPlanId, selectedWeekId, progressState);
        renderPlan();

        if (status === "done") {
          showToast("Nice work ‚úÖ");
          if (currentPlan.meta.id === "isla") {
            triggerConfetti();
          }
        } else if (status === "skipped") {
          showToast("Marked as missed");
        } else {
          showToast("Cleared status");
        }
      }

      function setActiveWeek(weekId) {
        selectedWeekId = weekId;
        progressState = loadProgress(currentPlanId, selectedWeekId);
        localStorage.setItem(storageWeekKey(currentPlanId), selectedWeekId);
        renderPlan();
      }

      if (startTodayBtn) {
        startTodayBtn.onclick = () => {
          if (!todayTargetId) return;
          const target = document.getElementById(todayTargetId);
          if (target) {
            target.scrollIntoView({ behavior: "smooth", block: "start" });
            highlightActiveChip(todayTargetId);
          }
        };
      }

      if (resetProgressBtn) {
        resetProgressBtn.onclick = () => {
          progressState = { completed: [], skipped: [] };
          saveProgress(currentPlanId, selectedWeekId, progressState);
          renderPlan();
          showToast("Week reset");
        };
      }

      function setActivePlan(planId) {
        const plan = PLANS[planId];
        if (!plan) return;
        currentPlanId = planId;
        currentPlan = plan;
        normalizedPlan = normalizePlan(plan);

        // Ensure weeks exist for template plans
        if (plan.totalWeeks && (!plan.weeks || plan.weeks.length === 0)) {
            normalizedPlan.weeks = [];
            for (let i = 1; i <= plan.totalWeeks; i++) {
                normalizedPlan.weeks.push({
                    id: `week-${i}`,
                    label: `Week ${i}`,
                    days: [] // Content resolved in renderPlan
                });
            }
        }

        localStorage.setItem(PLAN_KEY, planId);
        populatePicker(planId);

        const weeks = normalizedPlan.weeks || [];
        const storedWeek = localStorage.getItem(storageWeekKey(planId));
        const defaultWeek = weeks[0]?.id;
        selectedWeekId = weeks.some((week) => week.id === storedWeek)
          ? storedWeek
          : defaultWeek;

        populateWeekPicker(weeks, selectedWeekId);
        setActiveWeek(selectedWeekId || defaultWeek);
      }

      // --- Gamification Logic ---

      function updateGamification() {
        // Detect Isla plan
        const isIslaPlan = currentPlan?.meta?.id === "isla";
        const storedToggle = localStorage.getItem(GAMIFY_TOGGLE_KEY);
        const isEnabled = storedToggle !== "false"; // Default true

        // Update toggle UI state
        gamificationToggle.checked = isEnabled;

        if (!isIslaPlan || !isEnabled) {
            gamificationDashboard.style.display = "none";
            return;
        }

        gamificationDashboard.style.display = "block";

        // Calculate Stats
        const stats = calculateStats();

        // Render Dashboard
        renderDashboard(stats);
      }

      function calculateStats() {
        if (!normalizedPlan) return {};

        let totalPoints = 0;
        let weeklyPoints = 0;
        let weekSessionsDone = 0;
        let weekSessionsTotal = 0;
        let weeksCompleted = 0;
        let hasPerfectStrengthWeek = false;
        let restDaysTaken = 0;

        // Determine which weeks to process
        let weeksToProcess = normalizedPlan.weeks;

        // Fix for Isla (Template Plan): Resolve weeks 1..Total to get actual days
        if (currentPlan.meta.id === 'isla' && currentPlan.totalWeeks) {
            weeksToProcess = [];
            for (let i = 1; i <= currentPlan.totalWeeks; i++) {
                const wId = `week-${i}`;
                // Resolve for week i
                const view = resolvePlanForWeek(currentPlan, i);
                weeksToProcess.push({
                    id: wId,
                    days: view.days // This now has the actual blocks/items
                });
            }
        }

        weeksToProcess.forEach(week => {
             const progress = loadProgress(currentPlanId, week.id) || { completed: [], skipped: [] };

             let weekPoints = 0;
             let weekDoneCount = 0;
             let weekPlanCount = week.days.length;

             // Count strength days in this week to check for "Strength Focus"
             // Isla's plan: Strength is Day 1 and Day 4.
             // We check if all days with focus "Strength..." are done.
             let weekStrengthTotal = 0;
             let weekStrengthDone = 0;

             week.days.forEach((day, idx) => {
                 // Identify Rest Day
                 const isRest = day.focus === "Rest";
                 const dayId = day.id || day.day || day.name || `day-${idx + 1}`;
                 const isDone = progress.completed.includes(dayId);

                 const isStrength = day.focus && day.focus.includes("Strength");

                 if (isStrength) {
                    weekStrengthTotal++;
                 }

                 if (isDone) {
                     if (isRest) {
                         weekPoints += 5;
                         restDaysTaken++;
                     } else {
                         weekPoints += 10;
                     }

                     if (isStrength) {
                        weekStrengthDone++;
                     }

                     weekDoneCount++;
                 }

                 // Add bonus points if they exist for this day
                 if (progress.bonuses && progress.bonuses[dayId]) {
                      weekPoints += (progress.bonuses[dayId].points || 0);
                 }
             });

             if (weekStrengthTotal > 0 && weekStrengthDone === weekStrengthTotal) {
                hasPerfectStrengthWeek = true;
             }

             totalPoints += weekPoints;

             // If this is the currently selected week, update weekly stats
             if (week.id === selectedWeekId) {
                 weeklyPoints = weekPoints;
                 weekSessionsDone = weekDoneCount;
                 weekSessionsTotal = weekPlanCount;
             }

             // Prompt: "First Week Completed".
             // We use >= 40 points as a heuristic for a "completed" training week.
             if (weekPoints >= 40) {
                 weeksCompleted++;
             }
        });

        // Persist points as requested
        if (currentPlanId === "isla") {
            localStorage.setItem("points_v1:isla", totalPoints);
        }

        return {
            totalPoints,
            weeklyPoints,
            weekSessionsDone,
            weekSessionsTotal,
            weeksCompleted,
            hasPerfectStrengthWeek,
            restDaysTaken
        };
      }

      function renderDashboard(stats) {
          // Weekly Scorecard
          weeklyPointsEl.textContent = stats.weeklyPoints;
          sessionsCompletedEl.textContent = `${stats.weekSessionsDone}/${stats.weekSessionsTotal}`;

          // Coach Message (random but deterministic per day/week? Random is fine for now)
          if (!coachMessageEl.textContent || Math.random() > 0.8) {
             const msg = COACH_MESSAGES[Math.floor(Math.random() * COACH_MESSAGES.length)];
             coachMessageEl.textContent = `‚Äú${msg}‚Äù`;
          }

          // Progress Bar
          // Goal: 120 points = 12 weeks * 10 points/week??
          // Wait, 12 weeks * 10 points is very low.
          // Prompt says: "Goal: e.g. 120 points = 12 solid weeks".
          // Actually 10 points is 1 session.
          // If Isla does 4 sessions/week = 40 pts.
          // 12 weeks * 40 pts = 480 pts.
          // Maybe the prompt meant "120 points" as an arbitrary example.
          // Goal: 120 points (Season progress)
          const GOAL_POINTS = 120;
          const percentage = Math.min((stats.totalPoints / GOAL_POINTS) * 100, 100);
          totalProgressBar.style.width = `${percentage}%`;
          totalPointsLabel.textContent = `${stats.totalPoints} / ${GOAL_POINTS} pts`;

          // Badges
          renderBadges(stats);
      }

      function renderBadges(stats) {
          badgesContainer.innerHTML = "";

          // Retrieve stored badges
          const storedBadges = JSON.parse(localStorage.getItem(BADGES_KEY) || "[]");
          const newUnlocked = [];

          BADGES.forEach(badge => {
              const isUnlocked = storedBadges.includes(badge.id) || badge.check(stats);

              if (isUnlocked && !storedBadges.includes(badge.id)) {
                  newUnlocked.push(badge.id);
              }

              const badgeEl = document.createElement("div");
              badgeEl.className = `achievement-badge ${isUnlocked ? "unlocked" : ""}`;
              badgeEl.innerHTML = `<span class="achievement-badge-icon">${badge.icon}</span> ${badge.label}`;
              badgesContainer.append(badgeEl);
          });

          // Save new unlocks
          if (newUnlocked.length > 0) {
              const updated = [...storedBadges, ...newUnlocked];
              localStorage.setItem(BADGES_KEY, JSON.stringify(updated));
          }
      }

      // Toggle Event Listener
      gamificationToggle.addEventListener("change", (e) => {
          localStorage.setItem(GAMIFY_TOGGLE_KEY, e.target.checked);
          updateGamification();
      });

      // Initial
      const startingPlanId = getDefaultPlanId();
      setActivePlan(startingPlanId);

      planPicker.addEventListener("change", (event) => {
        setActivePlan(event.target.value);
      });

      weekPicker.addEventListener("change", (event) => {
        setActiveWeek(event.target.value);
      });
    </script>
  </body>
</html>
